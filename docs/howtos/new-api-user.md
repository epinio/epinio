# How To Add a New User For API Access

## Background and specification

Access to Epinio's API server is currently controlled by Traefik's BasicAuth middleware.

The list of allowed users and their credentials (hashes actually) is retrieved from the
kubernetes secret `epinio-api-auth-secret` found in namespace `epinio`. The relevant data
key is `users`.

The value of the secret (before the base64 encoding done by kubernetes) is a text block
where each line specifies a user with a hash of their credentials. User name and hash are
separated by a single colon (`:`) character, with no spaces. Neither leading nor trailing
spaces are allowed either.

An entire suitable line of user and hash for user and password can be generated by

> htpasswd -bcB hashfile user password

The given options create (`-c`) the password file, take (`-b`) the password from the
command line, and, most importantly use Bcrypt (`-B`) for the output.

### Example

For our example we use the default user stored in the secret by a particular run of
`epinio install`:

Given user `db33fa940b855218` and password `a1bd8fbc58c6ec55` the secret contains the
single line

> db33fa940b855218:$2a$10$upHKr9PT0YB4B1vEaFvWve6l1qW2oSW79VDeFTTbw8mNIcUpjE/lO

## Adding a new user

Given the previous information the process of adding a new user U with password P able to
access the Epinio API server is as follows:

  1. Get the list of currently allowed users from secret `epinio-api-auth-secret`
     (namespace `epinio`) and store it into a file:

     ```
     kubectl get secret -n epinio epinio-api-auth-secret -o jsonpath='{.data.users}' | \
         base64 -d > USERS
     ```

  2. Create the hash line for the new user `U` and its password `P`:

     ```
     htpasswd -bcB NEW_CREDENTIALS U P
     ```

  3. Edit the file `USERS` and append the contents of file `NEW_CREDENTIALS` as a new line
     to it.

     __Beware__, the default value created by epinio does not have a terminating end of
     line. Simply using `cat >> USERS NEW_CREDENTIALS` will extend the existing line
     instead of appending a proper new line. This will break all access should this result
     be uploaded into the cluster.

  4. Change the content of key `users` in secret `epinio-api-auth-secret` (namespace
     `epinio`) to the new contents of file `USERS`:

     ```
     kubectl get secret -n epinio epinio-api-auth-secret -o json | \
         jq --arg newvalue "$(cat USERS | base64)" '.data["users"]=$newvalue' | \
         kubectl apply -f -
     ```

     This non-interactive command directly edit a secret's key by retrieving the entire
     secret, replacing the specific key with the new data (base64-encoded!) and applying
     the changed json as the new secret.
